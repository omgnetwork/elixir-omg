name: Enforce changelog labels

on:
  pull_request:
    types: [opened, labeled, unlabeled]
    branches: [master]

jobs:
  enforce-changelog-label:
    runs-on: ubuntu-latest
    env:
      APPROVAL_MESSAGE: "The PR has a valid changelog label."
      REJECTION_MESSAGE: "The PR is missing a valid changelog label."
      # When updating the labels here, also update the `configure-sections` of the `.github_changelog_generator` file
      ONE_OF_LABELS: "api|enhancement|breaking|bug|chore|documentation"
    steps:
      - name: Check the PR for a changelog label
        id: check-changelog-label
        continue-on-error: true
        run: |
          set -o xtrace
          # Using the issues API instead of pulls because it can return only the labels
          curl "https://api.github.com/repos/omgnetwork/elixir-omg/issues/${{ github.event.pull_request.number }}/labels" \
          | grep -o '"name": "[^"]*' \
          | cut -d'"' -f4 \
          | grep -E $ONE_OF_LABELS

      - name: Approve the PR if a changelog label is found
        if: steps.check-changelog-label.outcome == 'success'
        run: |
          echo $APPROVAL_MESSAGE
          curl -X POST "https://api.github.com/repos/omgnetwork/elixir-omg/pulls/${{ github.event.pull_request.number }}/reviews" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.HOUSE_KEEPER_BOT_TOKEN }}" \
            --data "{\"event\": \"APPROVE\", \"body\": \"${APPROVAL_MESSAGE}\"}"

      - name: Request change on the PR if a changelog label is missing
        if: steps.check-changelog-label.outcome == 'failure'
        run: |
          echo $REJECTION_MESSAGE
          curl -X POST "https://api.github.com/repos/omgnetwork/elixir-omg/pulls/${{ github.event.pull_request.number }}/reviews" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.HOUSE_KEEPER_BOT_TOKEN }}" \
            --data "{\"event\": \"REQUEST_CHANGES\", \"body\": \"${REJECTION_MESSAGE} Label the PR with one of: ${ONE_OF_LABELS//|/, }.\"}"
